## Collection
### ARP Cache Poisoning (MITRE ATT&CK T1557.002)

| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. Gratuitous ARP Replies from Unauthorized Hosts | Adversaries may send unsolicited (gratuitous) ARP replies to poison caches without prior requests, targeting high-traffic segments in Windows/Linux LANs to intercept traffic. High risk in flat networks with no ARP inspection. | - Network Traffic Content (e.g., Zeek ARP logs, PCAP from Wireshark/Snort)<br>- Network Traffic Flow (e.g., NetFlow, switch logs) | - **Splunk**: `index=network sourcetype=zeek_arp \| where opcode="reply" AND request_ip IS NULL \| stats count by src_mac, dst_ip \| where count > 5` (Looks for replies without matching requests; threshold for anomalies).<br>- **KQL (Sentinel/XDR)**: `DeviceNetworkEvents \| where ActionType == "ArpReply" and AdditionalFields.requestIp == "" \| summarize count() by InitiatingProcessSHA256, RemoteIP \| where count_ > 5`.<br>- **ELK/SQL-like**: `FROM logs-zeek.arp-* \| WHERE opcode = 'reply' AND request.ip IS NULL \| STATS COUNT() BY source.mac GROUP BY destination.ip HAVING COUNT() > 5`. |
| 2. Multiple IPs Mapping to Single MAC in ARP Caches | Adversaries poison endpoint ARP caches, causing duplicate MAC associations (e.g., attacker claims multiple IPs). Common in Windows environments; hunt via periodic cache audits. | - Endpoint ARP Cache Changes (e.g., Windows Event Logs ID 2003/2004 via Sysmon, Linux /proc/net/arp via auditd)<br>- Network Traffic Content | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=10 \| search "arp.exe" OR "Get-NetNeighbor" \| rex field=Message "IP=(?<ip>\S+) MAC=(?<mac>\S+)" \| stats dc(ip) by mac \| where dc_ip > 1` (Detects duplicates).<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "arp -a" \| extend IP = extract("IP: (\\S+)", 1, ProcessCommandLine), MAC = extract("MAC: (\\S+)", 1, ProcessCommandLine) \| summarize UniqueIPs = dcount(IP) by MAC \| where UniqueIPs > 1`.<br>- **ELK**: `FROM logs-endpoint.events-* \| WHERE event.code = "10" AND process.args : "arp*" \| STATS DISTINCT_COUNT(ip_address) BY mac_address HAVING DISTINCT_COUNT(ip_address) > 1`. |
| 3. ARP Replies Faster Than Legitimate Responses | Adversaries race to reply to ARP requests before legitimate hosts, poisoning caches in real-time. Detect via timing anomalies in high-visibility networks (e.g., with packet timestamps). | - Network Traffic Content (e.g., Suricata ARP alerts, Zeek with timestamps)<br>- Packet Captures | - **Splunk**: `index=network sourcetype=suricata protocol=arp \| eval response_time = mvindex(timestamp,1) - mvindex(timestamp,0) \| where opcode="reply" AND response_time < 0.01 \| stats count by src_mac` (Flags sub-10ms replies as suspicious).<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "ARP" and ActionType == "Reply" \| extend ResponseDelta = datetime_diff('millisecond', Timestamp, PreviousEvent.Timestamp) \| where ResponseDelta < 10 \| summarize by DeviceId, RemoteIP`.<br>- **ELK**: `FROM logs-suricata-* \| WHERE event.module = 'arp' AND event.kind = 'reply' \| EVAL delta = @timestamp - lag(@timestamp, 1) OVER (PARTITION BY source.mac) \| WHERE delta < 10ms \| STATS COUNT() BY source.mac`. |
| 4. Unknown/Unexpected Hardware Devices via ARP | Adversaries introduce rogue devices (e.g., Raspberry Pi) that send ARP to poison caches. Hunt in environments with DHCP integration for MAC mismatches. | - Network Traffic Flow (e.g., DHCP logs, switch port security)<br>- Device Inventory (e.g., asset management tools) | - **Splunk**: `index=network sourcetype=dhcp \| join src_mac [search sourcetype=arp] \| where NOT src_mac IN (known_macs_list) \| stats values(ip) by src_mac` (Correlates unknown MACs from ARP with DHCP).<br>- **KQL**: `DeviceNetworkEvents \| where ActionType == "DhcpLease" or ActionType == "ArpRequest" \| where not( InitiatingProcessSHA256 in~ (knownDevices) ) \| summarize IPs = make_set(RemoteIP) by DeviceId`.<br>- **ELK**: `FROM logs-dhcp-* \| JOIN logs-arp-* ON source.mac \| WHERE source.mac NOT IN ["known_mac1", "known_mac2"] \| STATS VALUES(ip) BY source.mac`. |
| 5. ARP Poisoning Tool Artifacts on Endpoints | Adversaries use tools like arpspoof, Ettercap, or Scapy for poisoning. Detect process creation or command-line in Windows/Linux endpoints. | - Process Creation (e.g., Sysmon Event ID 1, auditd execve)<br>- Command Execution Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 \| search Image="*ettercap*" OR Image="*arpspoof*" OR CommandLine="*scapy*" \| table _time, host, CommandLine`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("ettercap", "arpspoof", "scapy.all") or ProcessCommandLine contains "arp spoof" \| project Timestamp, DeviceName, ProcessCommandLine`.<br>- **ELK**: `FROM logs-endpoint.events.process-* \| WHERE event.category = 'process' AND (process.name : "ettercap*" OR process.args : "*arp*spoof*") \| TABLE @timestamp, host.name, process.command_line`. |
| 6. Anomalous ARP Traffic Volume Spikes | Adversaries flood with ARP replies during poisoning campaigns, causing volume spikes in Linux-heavy environments. | - Network Traffic Content (e.g., Zeek/Snort aggregate stats)<br>- Flow Metrics | - **Splunk**: `index=network sourcetype=zeek_arp \| timechart span=1h count by opcode \| where opcode="reply" AND count > avg(count)*3` (Baselines and alerts on 3x spikes).<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "ARP" \| summarize HourlyCount = count() by bin(Timestamp, 1h), ActionType \| where ActionType == "Reply" and HourlyCount > avg(HourlyCount) * 3`.<br>- **ELK**: `FROM logs-zeek.arp-* \| STATS COUNT() BY date_histogram(field='@timestamp', interval='1h'), opcode \| WHERE opcode = 'reply' AND COUNT() > AVG(COUNT()) * 3`. |
| 7. ARP Cache Changes Correlated with MitM Indicators | Post-poisoning, adversaries manipulate traffic; hunt cache changes followed by unexpected redirects (e.g., in cloud-hybrid setups with VPNs). | - Endpoint Logs (e.g., Windows NetNeighbor changes)<br>- Network Traffic Flow | - **Splunk**: `index=endpoint sourcetype=win_event \| search EventID=2003 \| join host [search sourcetype=network "unexpected_redirect"] \| stats count by mac, ip`.<br>- **KQL**: `DeviceNetworkEvents \| where ActionType == "ArpCacheUpdate" \| join kind=inner (DeviceNetworkEvents \| where ActionType == "ConnectionRedirected") on DeviceId \| summarize by Timestamp, RemoteIP`.<br>- **ELK**: `FROM logs-windows-* \| WHERE winlog.event_id = 2003 \| JOIN logs-network-* ON host.id WHERE event.action = 'redirect' \| STATS COUNT() BY mac, ip`. |
| 8. Gratuitous ARP from Non-Gateway Devices | Adversaries mimic gateways with gratuitous ARP to poison multiple hosts; detect in segmented networks. | - Network Traffic Content<br>- Device Logs | - **Splunk**: `index=network sourcetype=arp \| where opcode="reply" AND src_ip != gateway_ip \| stats count by src_mac \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where ActionType == "GratuitousArp" and RemoteIP != "gateway_ip" \| summarize SuspiciousCount = count() by DeviceId \| where SuspiciousCount > 10`.<br>- **ELK**: `FROM logs-arp-* \| WHERE opcode = 'reply' AND source.ip != '192.168.1.1' \| STATS COUNT() BY source.mac HAVING COUNT() > 10`. |
| 9. ARP Poisoning in Conjunction with Credential Harvesting | Adversaries combine poisoning with tools like Responder for LLMNR poisoning; hunt in Windows domains. | - Network Traffic Content (ARP + LLMNR)<br>- Service Creation Logs | - **Splunk**: `index=network (sourcetype=arp opcode="reply") OR (sourcetype=llmnr "responder") \| transaction src_mac maxspan=1m \| where eventcount > 1 \| table src_mac, _time`.<br>- **KQL**: `DeviceNetworkEvents \| where (Protocol == "ARP" and ActionType == "Reply") or (Protocol == "LLMNR" and ActionType == "Query") \| summarize Events = make_set(ActionType) by bin(Timestamp, 1m), DeviceId \| where array_length(Events) > 1`.<br>- **ELK**: `FROM logs-network-* \| WHERE (event.module = 'arp' AND event.kind = 'reply') OR (event.module = 'llmnr' AND event.kind = 'query') \| STATS SET(events) BY date_histogram(@timestamp, '1m'), host.id \| WHERE CARDINALITY(events) > 1`. |
| 10. Dynamic ARP Inspection (DAI) Violations | Adversaries trigger DAI errors on switches during poisoning attempts; hunt in Cisco-managed networks. | - Switch Logs (e.g., Cisco syslog for DAI)<br>- Network Alerts | - **Splunk**: `index=network sourcetype=cisco:ios "DAI" "invalid ARP" \| stats count by src_mac, interface \| where count > 1` (From Splunk Security Content).<br>- **KQL**: `DeviceAlertEvents \| where AlertTitle contains "DAI Violation" or Description contains "ARP Inspection" \| summarize by Timestamp, RemoteIP`.<br>- **ELK**: `FROM logs-cisco-* \| WHERE message : "*DAI*invalid*ARP*" \| STATS COUNT() BY source.mac, interface HAVING COUNT() > 1`.


### Adversary-in-the-Middle

| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. LLMNR/NBT-NS Poisoning via Unsolicited Responses | Adversaries respond to LLMNR/NBT-NS queries with falsified information to redirect traffic, common in Windows environments for credential relay attacks. High risk in domains without mDNS disabled. | - Network Traffic Content (e.g., Zeek DNS/LLMNR logs, PCAP)<br>- Network Traffic Flow (e.g., NetFlow with protocol metadata) | - **Splunk**: `index=network sourcetype=zeek_llmnr \| where opcode="response" AND query_type="A" AND src_ip NOT IN (known_dns_servers) \| stats count by src_ip, queried_name \| where count > 5` (Detects unsolicited responses from non-DNS servers).<br>- **KQL (Sentinel/XDR)**: `DeviceNetworkEvents \| where Protocol == "LLMNR" and ActionType == "Response" and RemoteIP !in~ (knownDNSServers) \| summarize count() by RemoteIP, AdditionalFields.queriedName \| where count_ > 5`.<br>- **ELK/SQL-like**: `FROM logs-zeek.llmnr-* \| WHERE event.kind = 'response' AND source.ip NOT IN ['dns1', 'dns2'] \| STATS COUNT() BY source.ip, query.name HAVING COUNT() > 5`. |
| 2. Relay Attacks Following LLMNR Poisoning | Adversaries use tools like Responder to relay captured NTLM hashes after poisoning. Hunt in Windows-heavy networks for relay indicators post-poisoning. | - Network Traffic Content (e.g., Suricata NTLM rules)<br>- Endpoint Process Creation (e.g., Sysmon ID 1 for Responder.exe) | - **Splunk**: `index=network sourcetype=suricata "NTLM relay" OR index=endpoint sourcetype=sysmon EventCode=1 Image="*responder.exe*" \| transaction src_ip maxspan=5m \| where eventcount > 1 \| table _time, src_ip`.<br>- **KQL**: `DeviceNetworkEvents \| where ActionType == "NtlmRelay" or (DeviceProcessEvents \| where ProcessName == "Responder.exe") \| join kind=inner on DeviceId \| project Timestamp, RemoteIP`.<br>- **ELK**: `FROM logs-suricata-* \| WHERE message : "*NTLM*relay*" \| JOIN logs-endpoint.events.process-* ON host.id WHERE process.name = 'responder.exe' \| STATS COUNT() BY @timestamp, source.ip`. |
| 3. DHCP Spoofing via Rogue Servers | Adversaries set up rogue DHCP servers to assign malicious gateways/DNS, enabling AiTM. Common in wireless or unsecured LANs (Windows/Linux/cloud edge). | - Network Traffic Content (e.g., Zeek DHCP logs)<br>- Switch Logs (e.g., DHCP snooping violations) | - **Splunk**: `index=network sourcetype=zeek_dhcp \| where type="offer" AND server_ip NOT IN (authorized_dhcp_servers) \| stats values(assigned_ip) by server_ip \| where count > 3`.<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "DHCP" and ActionType == "Offer" and RemoteIP !in~ (authorizedServers) \| summarize AssignedIPs = make_set(AdditionalFields.assignedIp) by RemoteIP \| where array_length(AssignedIPs) > 3`.<br>- **ELK**: `FROM logs-zeek.dhcp-* \| WHERE event.kind = 'offer' AND server.ip NOT IN ['dhcp1'] \| STATS SET(assigned.ip) BY server.ip HAVING CARDINALITY(assigned.ip) > 3`. |
| 4. Anomalous DHCP Lease Assignments | Adversaries issue short-lived leases or unusual options (e.g., WPAD) via spoofed DHCP for AiTM persistence. Hunt in dynamic IP environments. | - Network Traffic Flow (e.g., DHCP option fields in PCAP)<br>- Endpoint Logs (e.g., Windows Event ID 169 for DHCP) | - **Splunk**: `index=network sourcetype=dhcp \| where option_code=252 OR lease_time < 300 \| stats count by client_mac, option_value \| where count > 10` (Flags WPAD or short leases).<br>- **KQL**: `DeviceNetworkEvents \| where AdditionalFields.optionCode == 252 or AdditionalFields.leaseTime < 300 \| summarize count() by DeviceId, AdditionalFields.optionValue \| where count_ > 10`.<br>- **ELK**: `FROM logs-dhcp-* \| WHERE dhcp.option.code = 252 OR dhcp.lease.time < 300 \| STATS COUNT() BY client.mac, dhcp.option.value HAVING COUNT() > 10`. |
| 5. ARP Cache Poisoning (Expanded from Sub-Technique) | Building on T1557.002, adversaries poison ARP for local MitM; detect via cache mismatches in mixed OS environments. | - Endpoint ARP Cache (e.g., Sysmon, auditd)<br>- Network Traffic Content | - **Splunk**: `index=endpoint sourcetype=sysmon "arp cache" \| rex "IP=(?<ip>\S+) MAC=(?<mac>\S+)" \| stats values(mac) by ip \| where mvcount(mac) > 1` (Multiple MACs per IP).<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "arp" \| extend IP=extract("IP:(\\S+)",1,ProcessCommandLine), MAC=extract("MAC:(\\S+)",1,ProcessCommandLine) \| summarize MACs=make_set(MAC) by IP \| where array_length(MACs) > 1`.<br>- **ELK**: `FROM logs-endpoint-* \| WHERE message : "*arp*cache*" \| STATS SET(mac) BY ip HAVING CARDINALITY(mac) > 1`. |
| 6. SSL/TLS Downgrade or Stripping Attacks | Adversaries perform SSL stripping (HSTS bypass) in AiTM to intercept HTTPS traffic. High risk in public Wi-Fi or cloud proxies. | - Network Traffic Content (e.g., Zeek HTTP/SSL logs)<br>- Proxy Logs (e.g., Squid, Zscaler) | - **Splunk**: `index=network sourcetype=zeek_http \| where status=301 AND uri="*http://" AND referer="*https://" \| stats count by src_ip, host \| where count > 5` (HTTPS to HTTP redirects).<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "HTTP" and AdditionalFields.status == 301 and AdditionalFields.uri startswith "http://" and AdditionalFields.referer startswith "https://" \| summarize count() by RemoteIP, AdditionalFields.host \| where count_ > 5`.<br>- **ELK**: `FROM logs-zeek.http-* \| WHERE http.status = 301 AND http.uri : "http://*" AND http.referer : "https://*" \| STATS COUNT() BY source.ip, http.host HAVING COUNT() > 5`. |
| 7. Rogue Access Point Detection | Adversaries deploy evil twin APs for wireless AiTM, spoofing SSIDs. Hunt in enterprise Wi-Fi environments (Linux/AP hardware). | - Wireless Logs (e.g., Cisco WLC, Aruba)<br>- Endpoint Connection Events (e.g., Windows WLAN-AutoConfig) | - **Splunk**: `index=wireless sourcetype=cisco:wlc "rogue AP" OR EventID=110002 \| stats count by ssid, mac \| where count > 1 AND ssid IN (corporate_ssids)`.<br>- **KQL**: `DeviceNetworkEvents \| where ActionType == "WlanConnection" and AdditionalFields.ssid in~ (corporateSSIDs) \| summarize count() by AdditionalFields.mac \| where count_ > 1`.<br>- **ELK**: `FROM logs-wireless-* \| WHERE message : "*rogue*AP*" OR winlog.event_id = 110002 \| STATS COUNT() BY ssid, mac HAVING COUNT() > 1 AND ssid IN ['corp1']`. |
| 8. Unexpected Proxy or Tunnel Usage in AiTM | Adversaries force traffic through malicious proxies (e.g., via WPAD) for interception. Common in cloud-hybrid setups. | - Proxy Logs (e.g., web gateway events)<br>- Browser Extension Logs | - **Splunk**: `index=proxy sourcetype=bluecoat \| where proxy_url NOT IN (approved_proxies) OR action="denied" "suspicious tunnel" \| stats values(user) by proxy_url \| where count > 10`.<br>- **KQL**: `DeviceNetworkEvents \| where RemoteUrl !in~ (approvedProxies) or ActionType == "ProxyDenied" \| summarize Users=make_set(InitiatingProcessAccountName) by RemoteUrl \| where array_length(Users) > 10`.<br>- **ELK**: `FROM logs-proxy-* \| WHERE url : NOT IN ['proxy1'] OR event.action = 'denied' \| STATS SET(user) BY url HAVING CARDINALITY(user) > 10`. |
| 9. Credential Harvesting via AiTM Pharming | Adversaries redirect to fake login pages post-AiTM (e.g., via DNS poisoning). Hunt for pharming indicators in web traffic. | - Network Traffic Content (e.g., Suricata HTTP rules for phishing)<br>- DNS Logs | - **Splunk**: `index=network (sourcetype=dns "unexpected resolution") OR sourcetype=http "login phishing" \| transaction domain maxspan=1m \| where eventcount > 1 \| table domain, src_ip`.<br>- **KQL**: `DeviceNetworkEvents \| where (Protocol == "DNS" and ActionType == "UnexpectedResolution") or (Protocol == "HTTP" and AdditionalFields contains "login") \| join kind=inner on RemoteUrl \| project RemoteUrl, InitiatingProcessAccountSid`.<br>- **ELK**: `FROM logs-dns-* \| WHERE event.action = 'unexpected' \| JOIN logs-http-* ON domain WHERE message : '*login*phishing*' \| STATS COUNT() BY domain, source.ip`. |
| 10. AiTM Tool Execution on Compromised Hosts | Adversaries run tools like Bettercap, Mitmproxy for AiTM. Detect in Linux/Windows endpoints with deep visibility. | - Process Creation (e.g., Sysmon ID 1, auditd)<br>- Command-Line Auditing | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 \| search Image IN ("*bettercap*", "*mitmproxy*", "*sslsplit*") \| table _time, host, CommandLine`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("bettercap", "mitmproxy", "sslsplit") \| project Timestamp, DeviceName, ProcessCommandLine`.<br>- **ELK**: `FROM logs-endpoint.events.process-* \| WHERE process.name IN ['bettercap', 'mitmproxy'] \| TABLE @timestamp, host.name, process.command_line`. |
| 11. Traffic Redirection Anomalies in Cloud Environments | In cloud (AWS/Azure), adversaries use VPC peering or route table hijacks for AiTM. Hunt via cloud logs. | - Cloud Audit Logs (e.g., AWS CloudTrail, Azure Activity Logs)<br>- Network Flow Logs (VPC Flow) | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName="ModifyRouteTable" OR "Unauthorized peering" \| stats count by userIdentity, resource \| where count > 1`.<br>- **KQL**: `AzureActivity \| where OperationNameValue == "Microsoft.Network/routeTables/routes/write" \| summarize count() by Caller, ResourceId \| where count_ > 1`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action = 'ModifyRouteTable' \| STATS COUNT() BY user.identity, resource HAVING COUNT() > 1`. |
| 12. NBT-NS Query Flooding for DoS/AiTM Setup | Adversaries flood NBT-NS queries to exhaust resources before poisoning. Detect spikes in Windows networks. | - Network Traffic Flow (e.g., NetFlow volume)<br>- DNS Logs | - **Splunk**: `index=network sourcetype=nbtns \| timechart span=5m count by src_ip \| where count > avg(count)*5` (5x baseline spikes).<br>- **KQL**: `DeviceNetworkEvents \| where Protocol == "NBTNS" \| summarize MinCount=count() by bin(Timestamp, 5m), RemoteIP \| where MinCount > avg(MinCount) * 5`.<br>- **ELK**: `FROM logs-nbtns-* \| STATS COUNT() BY date_histogram(@timestamp, '5m'), source.ip \| WHERE COUNT() > AVG(COUNT()) * 5`. |
| 13. Combined AiTM with Lateral Movement | Adversaries use AiTM to capture creds for lateral movement; correlate poisoning with auth events. | - Authentication Logs (e.g., Windows 4624)<br>- Network Traffic Content | - **Splunk**: `index=security EventID=4624 \| join src_ip [search sourcetype=arp "poison"] \| where LogonType=3 \| stats values(target_user) by src_ip`.<br>- **KQL**: `SecurityEvent \| where EventID == 4624 and LogonType == 3 \| join kind=inner (DeviceNetworkEvents \| where ActionType == "ArpPoison") on RemoteIP \| summarize Users=make_set(AccountName) by RemoteIP`.<br>- **ELK**: `FROM logs-windows-* \| WHERE winlog.event_id = 4624 \| JOIN logs-arp-* ON source.ip WHERE event.action = 'poison' \| STATS SET(user) BY source.ip`. |
| 14. HSTS Bypass Attempts in AiTM | Adversaries attempt to bypass HSTS preloads during SSL stripping. Hunt in browser/telemetry-rich environments. | - Browser Logs (e.g., Chrome/Edge telemetry)<br>- HTTP Traffic | - **Splunk**: `index=browser sourcetype=chrome "HSTS bypass" OR sourcetype=http "preload ignore" \| stats count by domain, user_agent \| where count > 5`.<br>- **KQL**: `DeviceNetworkEvents \| where AdditionalFields contains "HSTS Bypass" or ActionType == "PreloadIgnore" \| summarize count() by AdditionalFields.domain, InitiatingProcessName \| where count_ > 5`.<br>- **ELK**: `FROM logs-browser-* \| WHERE message : "*HSTS*bypass*" \| STATS COUNT() BY domain, user.agent HAVING COUNT() > 5`. |
| 15. Persistent AiTM via Modified Network Configurations | Adversaries alter host configs (e.g., /etc/hosts, Windows hosts file) for long-term redirection. Hunt in Linux/Windows endpoints. | - File Modification Logs (e.g., Sysmon ID 11 for hosts file)<br>- Configuration Change Audits | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 TargetFilename="*hosts" \| table _time, host, ProcessGuid, TargetFilename`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileModified" and FolderPath endswith "hosts" \| project Timestamp, DeviceName, SHA256`.<br>- **ELK**: `FROM logs-endpoint.events.file-* \| WHERE event.action = 'modification' AND file.path : '*hosts' \| TABLE @timestamp, host.name, process.id, file.path`.


### Archive Collected Data

| Hypothesis | Description | Data Sources | Hunting Queries |
|------------|-------------|--------------|-----------------|
| 1. Use of Built-in Archiving Utilities on Sensitive Data | Adversaries use native tools like Compress-Archive (PowerShell) or tar/gzip to archive collected data in staging directories, common in Windows/Linux environments for compression before exfil. High risk in environments with unmonitored temp folders. | - Command Execution (e.g., Sysmon Event ID 1, auditd execve)<br>- File Creation/Modification (e.g., Sysmon ID 11) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 \| search CommandLine="*Compress-Archive*" OR CommandLine="*tar -czf*" OR CommandLine="*gzip*" \| where Path="*temp*" OR Path="*staging*" \| stats count by host, CommandLine \| where count > 5` (Detects archiving in suspicious paths).<br>- **KQL (Sentinel/XDR)**: `DeviceProcessEvents \| where ProcessCommandLine contains "Compress-Archive" or ProcessCommandLine contains "tar -czf" or ProcessCommandLine contains "gzip" and FolderPath has_any ("temp", "staging") \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK/SQL-like**: `FROM logs-endpoint.events.process-* \| WHERE event.category = "process" AND (process.args : "*Compress-Archive*" OR process.args : "*tar*czf*" OR process.args : "*gzip*") AND file.path : ("*temp*" OR "*staging*") \| STATS COUNT() BY host.name, process.command_line HAVING COUNT() > 5`. |
| 2. Third-Party Archiving Tool Execution | Adversaries deploy tools like 7-Zip, WinRAR, or zip for high-compression archiving, often in Windows environments. Hunt for process creation anomalies in non-standard installs. | - Process Creation (e.g., Sysmon ID 1)<br>- Module Load (e.g., Sysmon ID 7 for DLLs) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 \| search Image IN ("*7z.exe*", "*rar.exe*", "*zip.exe*") AND NOT Image IN (approved_paths) \| table _time, host, CommandLine`.<br>- **KQL**: `DeviceProcessEvents \| where FolderPath has_any ("7z.exe", "rar.exe", "zip.exe") and not(FolderPath in~ (approvedPaths)) \| project Timestamp, DeviceName, ProcessCommandLine`.<br>- **ELK**: `FROM logs-endpoint.events.process-* \| WHERE process.name IN ['7z.exe', 'rar.exe', 'zip.exe'] AND process.executable NOT IN ['C:\\Program Files\\*'] \| TABLE @timestamp, host.name, process.command_line`. |
| 3. Archive File Creation in Unusual Locations | Adversaries create .zip/.tar.gz files in user profiles or system dirs for staging. Common in Linux/cloud for data aggregation. | - File Creation (e.g., Sysmon ID 11, auditd create)<br>- Endpoint File System Changes | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=11 \| search TargetFilename=(*.zip OR *.tar.gz OR *.rar) AND (TargetFilename="*AppData*" OR TargetFilename="*tmp*") \| stats values(TargetFilename) by host \| where mvcount(TargetFilename) > 3`.<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileCreated" and FileName endswith_any (".zip", ".tar.gz", ".rar") and FolderPath has_any ("AppData", "tmp") \| summarize Files=make_set(FileName) by DeviceName \| where array_length(Files) > 3`.<br>- **ELK**: `FROM logs-endpoint.events.file-* \| WHERE event.action = 'creation' AND file.extension IN ['zip', 'tar.gz', 'rar'] AND file.path : ("*AppData*" OR "*tmp*") \| STATS SET(file.name) BY host.name HAVING CARDINALITY(file.name) > 3`. |
| 4. High-Entropy File Creations Indicating Custom Archiving | Adversaries use custom methods (e.g., scripts) creating high-entropy archived files. Hunt in environments with deep file telemetry for obfuscated data. | - File Metadata (e.g., custom entropy scanners via EDR)<br>- File Creation Logs | - **Splunk**: `index=endpoint sourcetype=edr_file \| where entropy > 7.0 AND file_extension IN ("bin", "dat", "archive") \| stats count by file_path, host \| where count > 1` (Assumes entropy field; threshold for compressed data).<br>- **KQL**: `DeviceFileEvents \| where AdditionalFields.entropy > 7.0 and FileName endswith_any ("bin", "dat") \| summarize count() by FolderPath, DeviceName \| where count_ > 1`.<br>- **ELK**: `FROM logs-edr.file-* \| WHERE file.entropy > 7.0 AND file.extension : ('bin' OR 'dat') \| STATS COUNT() BY file.path, host.name HAVING COUNT() > 1`. |
| 5. Archiving Followed by Network Exfiltration | Correlate archiving commands with subsequent outbound connections, common in cloud environments for data staging before upload. | - Process Network (e.g., Sysmon ID 3)<br>- Cloud Access Logs (e.g., AWS S3 PutObject) | - **Splunk**: `index=endpoint sourcetype=sysmon (EventCode=1 CommandLine="*zip*") OR (EventCode=3 DestinationPort=443) \| transaction ProcessGuid maxspan=5m \| where mvcount(EventCode)=2 \| table _time, host, DestinationIp`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "zip" \| join kind=inner (DeviceNetworkEvents \| where RemotePort == 443) on ProcessId \| project Timestamp, DeviceName, RemoteIP`.<br>- **ELK**: `FROM logs-endpoint.events.process-* \| WHERE process.args : "*zip*" \| JOIN logs-endpoint.events.network-* ON process.pid WHERE destination.port = 443 \| TABLE @timestamp, host.name, destination.ip`. |
| 6. Library-Based Archiving via API Calls | Adversaries use libraries like zlib or SharpCompress in custom malware for in-memory archiving. Hunt via module loads in Windows/Linux. | - Module Load (e.g., Sysmon ID 7 for zlib.dll)<br>- Process Memory Dumps (if available) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=7 \| search ImageLoaded IN ("*zlib*", "*libzip*", "*compression.dll*") AND ParentImage NOT IN (legit_apps) \| stats count by host, ImageLoaded`.<br>- **KQL**: `DeviceImageLoadEvents \| where FolderPath has_any ("zlib", "libzip") and not(InitiatingProcessFolderPath in~ (legitApps)) \| summarize count() by DeviceName, FolderPath`.<br>- **ELK**: `FROM logs-endpoint.events.library-* \| WHERE dll.name : ("*zlib*" OR "*libzip*") AND process.parent.name NOT IN ['chrome.exe'] \| STATS COUNT() BY host.name, dll.path`. |
| 7. Password-Protected Archive Creation | Adversaries add passwords to archives (e.g., zip -P) for evasion. Detect in high-risk environments with command-line auditing. | - Command Execution (e.g., Sysmon ID 1 with password flags) | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 \| search CommandLine=("*zip -P*" OR "*7z a -p*" OR "*rar a -hp*") \| table _time, host, CommandLine`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains_any ("zip -P", "7z a -p", "rar a -hp") \| project Timestamp, DeviceName, ProcessCommandLine`.<br>- **ELK**: `FROM logs-endpoint.events.process-* \| WHERE process.args : ("*zip*-P*" OR "*7z*a*-p*" OR "*rar*a*-hp*") \| TABLE @timestamp, host.name, process.command_line`. |
| 8. Archiving in Cloud Storage Buckets | In cloud (AWS/Azure), adversaries archive data via CLI/tools before syncing to buckets. Hunt via cloud audit logs. | - Cloud API Calls (e.g., AWS CloudTrail for s3:PutObject with .zip)<br>- Storage Logs | - **Splunk**: `index=cloud sourcetype=aws:cloudtrail eventName="PutObject" AND object_key=*.zip \| stats count by userIdentity, bucketName \| where count > 10`.<br>- **KQL**: `AWSCloudTrail \| where EventName == "PutObject" and AdditionalFields.objectKey endswith ".zip" \| summarize count() by Caller, ResourceId \| where count_ > 10`.<br>- **ELK**: `FROM logs-aws.cloudtrail-* \| WHERE event.action = 'PutObject' AND s3.object.key : '*.zip' \| STATS COUNT() BY user.identity, s3.bucket HAVING COUNT() > 10`. |
| 9. Anomalous File Size Changes Post-Archiving | Detect files shrinking significantly after archiving commands, indicating compression of large datasets in Linux servers. | - File Modification (e.g., auditd, Sysmon ID 2/11)<br>- Size Metrics | - **Splunk**: `index=endpoint sourcetype=auditd "type=SYSCALL" exe="*tar*" \| join path [search sourcetype=sysmon EventCode=11] \| eval size_change = new_size - old_size \| where size_change < -1000000 \| stats values(path) by host` (Flags >1MB reduction).<br>- **KQL**: `DeviceFileEvents \| where ActionType == "FileModified" and PreviousFileSize - FileSize > 1000000 \| join kind=inner (DeviceProcessEvents \| where ProcessCommandLine contains "tar") on FolderPath \| summarize Paths=make_set(FolderPath) by DeviceName`.<br>- **ELK**: `FROM logs-auditd-* \| WHERE event.module = 'syscall' AND process.exe : '*tar*' \| JOIN logs-endpoint.file-* ON file.path \| EVAL change = file.size.before - file.size.after \| WHERE change > 1000000 \| STATS SET(path) BY host.name`. |
| 10. Scripting for Batch Archiving Operations | Adversaries use scripts (e.g., bash/PowerShell) to archive multiple files. Hunt for script executions targeting data dirs in mixed environments. | - Script Execution (e.g., Sysmon ID 1 for powershell.exe)<br>- File Access Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 Image="*powershell.exe*" CommandLine="*Archive*" OR Image="*bash*" CommandLine="*tar*" \| stats count by host, CommandLine \| where count > 5`.<br>- **KQL**: `DeviceProcessEvents \| where (FolderPath endswith "powershell.exe" and ProcessCommandLine contains "Archive") or (FolderPath endswith "bash" and ProcessCommandLine contains "tar") \| summarize count() by DeviceName, ProcessCommandLine \| where count_ > 5`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE (process.name = 'powershell.exe' AND process.args : '*Archive*') OR (process.name = 'bash' AND process.args : '*tar*') \| STATS COUNT() BY host.name, process.command_line HAVING COUNT() > 5`. |
| 11. Archive via Custom Encryption/Compression Methods | Adversaries implement custom archiving with encryption (e.g., via Python zipfile with AES). Detect via unusual module loads or process behaviors. | - Module Load (e.g., Sysmon ID 7)<br>- Process Creation | - **Splunk**: `index=endpoint sourcetype=sysmon (EventCode=7 ImageLoaded="*pycryptodome*") OR (EventCode=1 Image="*python*" CommandLine="*zipfile*") \| transaction ProcessGuid maxspan=1m \| where eventcount > 1`.<br>- **KQL**: `DeviceImageLoadEvents \| where FolderPath contains "pycryptodome" \| join kind=inner (DeviceProcessEvents \| where FolderPath contains "python" and ProcessCommandLine contains "zipfile") on ProcessId`.<br>- **ELK**: `FROM logs-endpoint.library-* \| WHERE dll.name : '*pycryptodome*' \| JOIN logs-endpoint.process-* ON process.pid WHERE process.name = 'python' AND process.args : '*zipfile*' \| STATS COUNT() BY @timestamp`. |
| 12. Volume Spikes in File Archiving Activity | Detect sudden increases in archiving-related events, indicating bulk data collection in high-visibility cloud setups. | - Aggregate Metrics (e.g., SIEM volume stats)<br>- Process Logs | - **Splunk**: `index=endpoint sourcetype=sysmon EventCode=1 CommandLine="*archive*" \| timechart span=1h count \| where count > avg(count)*4` (4x baseline).<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "archive" \| summarize HourlyCount=count() by bin(Timestamp, 1h) \| where HourlyCount > avg(HourlyCount) * 4`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.args : '*archive*' \| STATS COUNT() BY date_histogram(@timestamp, '1h') \| WHERE COUNT() > AVG(COUNT()) * 4`. |
| 13. Archiving Correlated with Data Collection Techniques | Link archiving to prior collection (e.g., after screenshot capture or clipboard access) for chained behaviors. | - Multi-Event Correlation (e.g., Sysmon IDs 1, 11, 13) | - **Splunk**: `index=endpoint sourcetype=sysmon (EventCode=13 "clipboard") OR (EventCode=1 "*zip*") \| transaction host maxspan=10m \| where mvcount(EventCode)>1 \| table host, _time`.<br>- **KQL**: `DeviceProcessEvents \| where ProcessCommandLine contains "zip" \| join kind=inner (DeviceRegistryEvents \| where RegistryKey contains "clipboard") on DeviceName \| project DeviceName, Timestamp`.<br>- **ELK**: `FROM logs-endpoint.process-* \| WHERE process.args : '*zip*' \| JOIN logs-endpoint.registry-* ON host.name WHERE registry.key : '*clipboard*' \| TABLE host.name, @timestamp`. |
| 14. Archive Files with Embedded Exfil Indicators | Detect archives named suspiciously or with metadata hinting at exfil (e.g., timestamps near network events). | - File Metadata (e.g., EDR file details)<br>- Network Correlation | - **Splunk**: `index=endpoint sourcetype=edr_file file_name=(*exfil*.zip) OR metadata="*staged*" \| join file_path [search sourcetype=network "outbound"] \| stats values(file_name) by host`.<br>- **KQL**: `DeviceFileEvents \| where FileName contains "exfil" and FileName endswith ".zip" \| join kind=inner (DeviceNetworkEvents \| where ActionType == "Outbound") on FolderPath \| summarize Files=make_set(FileName) by DeviceName`.<br>- **ELK**: `FROM logs-edr.file-* \| WHERE file.name : '*exfil*.zip' \| JOIN logs-network-* ON file.path WHERE event.action = 'outbound' \| STATS SET(file.name) BY host.name`. |
| 15. Archiving in Containerized or Virtual Environments | In cloud/Kubernetes, adversaries archive data within pods/VMs. Hunt via container logs for tar/zip usage. | - Container Logs (e.g., Docker/K8s audit)<br>- Cloud Instance Metadata | - **Splunk**: `index=container sourcetype=k8s:events "exec" Command="*tar czf*" OR "*zip*" \| stats count by pod_name, namespace \| where count > 3`.<br>- **KQL**: `KubeEvents \| where Verb == "exec" and ObjectRef.subresource == "command" and Message contains_any ("tar czf", "zip") \| summarize count() by ObjectRef.name, ObjectRef.namespace \| where count_ > 3`.<br>- **ELK**: `FROM logs-kubernetes.events-* \| WHERE kubernetes.event.verb = 'exec' AND message : ('*tar*czf*' OR '*zip*') \| STATS COUNT() BY kubernetes.pod.name, kubernetes.namespace HAVING COUNT() > 3`.


